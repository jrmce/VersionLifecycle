<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <p class="text-sm text-slate-500 uppercase tracking-wide">Environment Overview</p>
      <h1 class="text-3xl font-semibold text-slate-900">Where versions are deployed</h1>
    </div>
    <div class="flex gap-3">
      <button
        class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-100 transition-colors"
        (click)="clearError.emit()"
        [disabled]="!error"
      >
        Clear Alerts
      </button>
      <button
        class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm transition-colors"
        (click)="reload.emit()"
      >
        Refresh
      </button>
    </div>
  </div>

  @if (error) {
    <div class="mb-4 p-4 rounded-lg border border-rose-200 bg-rose-50 text-rose-800 flex items-start justify-between">
      <div class="flex-1">
        <p class="font-medium">We ran into an issue loading the dashboard.</p>
        <p class="text-sm text-rose-700">{{ error }}</p>
      </div>
      <button class="text-rose-700 hover:text-rose-900" (click)="clearError.emit()">Dismiss</button>
    </div>
  }

  @if (loading) {
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      @for (skeleton of [1,2,3,4]; track skeleton) {
        <div class="h-48 rounded-xl bg-slate-100 animate-pulse"></div>
      }
    </div>
  } @else if (!environments.length) {
    <div class="bg-white border border-slate-200 rounded-xl p-10 text-center shadow-sm">
      <h2 class="text-xl font-semibold text-slate-800 mb-2">No environments yet</h2>
      <p class="text-slate-600 mb-4">Create environments to see deployed applications across stages.</p>
      <button class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700" (click)="reload.emit()">Reload</button>
    </div>
  } @else {
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      @for (environment of environments; track environment.environmentId) {
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="px-5 py-4 border-b border-slate-100 flex items-start justify-between">
            <div>
              <p class="text-xs uppercase tracking-wide text-slate-500">Environment</p>
              <h2 class="text-lg font-semibold text-slate-900">{{ environment.environmentName }}</h2>
              @if (environment.description) {
                <p class="text-sm text-slate-600">{{ environment.description }}</p>
              }
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-700">
              {{ environment.deployments.length }} deployments
            </span>
          </div>

          @if (environment.deployments.length === 0) {
            <div class="px-5 py-6 text-center text-slate-600">No deployments yet.</div>
          } @else {
            <div class="divide-y divide-slate-100">
              @for (deployment of environment.deployments; track deployment.deploymentId) {
                <div class="px-5 py-4 flex flex-col gap-2">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-semibold text-slate-900">{{ deployment.applicationName }}</p>
                      <p class="text-xs text-slate-500">Version {{ deployment.versionNumber }}</p>
                    </div>
                    <span
                      class="px-3 py-1 rounded-full text-xs font-semibold"
                      [ngClass]="{
                        'bg-emerald-100 text-emerald-800': deployment.status === 'Success',
                        'bg-amber-100 text-amber-800': deployment.status === 'Pending' || deployment.status === 'InProgress',
                        'bg-rose-100 text-rose-800': deployment.status === 'Failed' || deployment.status === 'Cancelled'
                      }"
                    >
                      {{ deployment.status }}
                    </span>
                  </div>
                  <div class="flex items-center text-xs text-slate-500 gap-3">
                    <span>Deployed: {{ deployment.deployedAt | date:'short' }}</span>
                    <span>Completed: {{ deployment.completedAt ? (deployment.completedAt | date:'short') : 'â€”' }}</span>
                  </div>
                  @if (nextEnvironment(environment.order); as nextEnv) {
                    <div class="pt-2">
                      <button
                        class="px-3 py-1 text-sm rounded-lg transition-colors"
                        [ngClass]="{
                          'bg-indigo-600 text-white hover:bg-indigo-700': !isVersionPresentInEnv(nextEnv, deployment.applicationId, deployment.versionId) && deployment.status === 'Success',
                          'bg-slate-200 text-slate-500 cursor-not-allowed opacity-60': isVersionPresentInEnv(nextEnv, deployment.applicationId, deployment.versionId) || deployment.status !== 'Success'
                        }"
                        [disabled]="isVersionPresentInEnv(nextEnv, deployment.applicationId, deployment.versionId) || deployment.status !== 'Success'"
                        (click)="promote.emit({ deploymentId: deployment.deploymentId, targetEnvironmentId: nextEnv.environmentId })"
                      >
                        Promote to {{ nextEnv.environmentName }}
                      </button>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  }
</div>
